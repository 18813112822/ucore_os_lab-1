# lab2 实验报告

## 练习0：填写已有实验

用git结合Linux自带的patch命令可以方便的做到这一点。 

	git diff <...> --relative=labcodes/lab1 | patch -d labcodes/lab2 -p1

## 练习1：实现 first-fit 连续物理内存分配算法（需要编程）

**请在实验报告中简要说明你的设计实现过程。**

1. 修改default_alloc_pages，实现first-fit算法的分配逻辑：找到最先的满足大小要求的连续空闲页，分配出要求的大小；修改空闲块的链表，将原来的块移除，然后将剩下的部分（如果有）插入链表。
2. 修改default_free_pages，设置被释放的页的标志和属性；修改空闲块的链表，将被释放的连续页插入，并在必要时与相邻的空闲块进行合并。

**请回答如下问题：你的first fit算法是否有进一步的改进空间**

free_pages当中合并的逻辑可能可以改进得更有效率。

## 练习2：实现寻找虚拟地址对应的页表项（需要编程）

**请在实验报告中简要说明你的设计实现过程。**

基本遵照注释来进行实现，即首先判断所需的PTE是否存在（`pgdir[PDX(la)] & PTE_P`），如果存在则直接返回`(pte_t*)KADDR(PTE_ADDR(*pdep)) + PTX(la)`；否则，若create参数为1，需要为PTE申请一个页，调用memset，设置该页的ref值为1，填入PDE的值，最后返回结果；而如果create为0，则直接返回NULL。

**请回答如下问题：**
**请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处。**

PDE有很多组成部分，其中ucore可能使用的包括：高20位（页表的物理地址），第5位（访问位，即是否被访问过；选择换出的页时会用到），第4位（禁用缓存位，对于IO设备会用到），第3位（写权限控制），第2位（用户态程序访问权限控制，但ucore设计当中似乎倾向于将这一控制推迟到二级页表，而在PDE当中不进行），第1位（读写权限控制），第0位（存在位，ucore当中用来判断对应的二级页表是否被分配了物理内存）。

PTE和PDE基本相同，但多了一位会被用到的，第6位（Dirty标志位，表征是否被写入过数据，这决定在将该页换出时是否把数据写回外部存储）。

**如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？**

1. 判断是否有空闲的页，如果有，跳到4；
2. 没有空闲的页，则需要换出，选择一个页，如果被写入过，将新的内容写入外部存储；
3. 换出该页，并修改对应页表项的存在位；
4. 将需要装入的页写入内存，并需要对应页表项的存在位。
5. 重新执行触发异常的指令。

## 练习3：释放某虚地址所在的页并取消对应二级页表项的映射（需要编程）

**请在实验报告中简要说明你的设计实现过程。**

基本遵照注释来实现，即首先判断对应的二级页表是否存在，找到对应的页，将ref值减1，如果减到了0则释放它；最后调用`tlb_invalidate`使对页表的修改生效。

**请回答如下问题：**
**数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？**

有。当一个二级页表映射到某个物理页，其所存储的物理地址（高20位）与某个page的`page2pa(page)`值相同。

**如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？ 鼓励通过编程来具体完成这个问题**

虚拟地址和物理地址的对应关系并不是一定的，因此我假定题目想问的是**内核**虚拟地址和物理地址相等。这需要修改调用`boot_map_segment`这一步，使内核所需的页映射到以0xC0000000为起始位置的一段内存（而非0x0）。